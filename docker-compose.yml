services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: itam-hack-backend
    ports:
      - "8000:8000"
    volumes:
      # Монтируем код для разработки (можно убрать в production)
      - ./backend:/app
      # Монтируем БД для персистентности
      - ./backend/data:/app/data
      - backend-db:/app
    environment:
      - DATABASE_URL=sqlite:///./data/database.sqlite
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-8270383153:AAH1fGA0U9JuSUA8Qc1-f4vvhXodLK2z2tw}
      - TELEGRAM_BOT_USERNAME=${TELEGRAM_BOT_USERNAME:-bdc_itam_hack_bot}
      - SECRET_KEY=${SECRET_KEY:-e1d083f7a30901221bd417ece379627f95ff5765a02d0c45eb89c4e9576a2134}
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=1440
      # ADMIN_EMAIL и ADMIN_PASSWORD берутся из config.py или .env файла
      # Если нужно переопределить, создайте .env файл в корне проекта
      # ADMIN_EMAIL=${ADMIN_EMAIL}
      # ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - CODE_EXPIRY_MINUTES=10
      - ALLOWED_ORIGINS=http://0.0.0.0:3000,http://0.0.0.0:5173,http://0.0.0.0:80,http://0.0.0.0,http://localhost:3000,http://localhost:5173,http://localhost:80,http://localhost
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: itam-hack-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  telegram-bot:
    build:
      context: ./backend
      dockerfile: Dockerfile.telegram
    container_name: itam-hack-telegram-bot
    depends_on:
      - backend
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-8270383153:AAH1fGA0U9JuSUA8Qc1-f4vvhXodLK2z2tw}
      - BACKEND_URL=http://backend:8000
      - FRONTEND_URL=http://0.0.0.0
    restart: unless-stopped

volumes:
  backend-db:
    driver: local

